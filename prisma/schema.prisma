// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js Models
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole  @default(USER)
  accounts      Account[]
  sessions      AuthSession[]
  createdSessions VotingSession[] @relation("CreatedSessions")
  recurringSessions RecurringSession[]
  participants  Participant[]
  invitations   Invitation[]
  companies     CompanyMember[]
  groupMemberships CompanyGroupMember[]
  hiddenSessions HiddenSession[]
  teacherClassrooms Classroom[] @relation("TeacherClassrooms")
  studentClassrooms ClassroomStudent[] @relation("StudentClassrooms")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model AuthSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

// Company/Organization Model
model Company {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  logo        String?
  domain      String?   // For SSO domain verification
  ssoEnabled  Boolean   @default(false)
  ssoProvider String?   // 'microsoft' | 'google' | 'saml'
  ssoConfig   Json?     // SSO configuration (clientId, tenantId, etc.)
  slackWebhook String?  // Slack integration webhook URL
  slackChannel String?  // Default Slack channel
  members     CompanyMember[]
  sessions    VotingSession[]
  groups      CompanyGroup[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model CompanyMember {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      CompanyRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  @@unique([companyId, userId])
}

enum CompanyRole {
  OWNER
  ADMIN
  MEMBER
}

// App Models
model VotingSession {
  id             String       @id @default(uuid())
  title          String
  date           DateTime?
  time           String?
  status         Status       @default(OPEN)
  evaluationInfo String?
  isAnonymous    Boolean      @default(true)
  creatorId      String?
  creator        User?        @relation("CreatedSessions", fields: [creatorId], references: [id], onDelete: SetNull)
  companyId      String?
  company        Company?     @relation(fields: [companyId], references: [id], onDelete: SetNull)
  organizerToken String?      @unique
  participants   Participant[]
  ballots        Ballot[]
  invitations    Invitation[]
  hiddenBy       HiddenSession[]
  // Recurring session fields
  recurringId    String?
  recurring      RecurringSession? @relation(fields: [recurringId], references: [id], onDelete: SetNull)
  classroomProject ClassroomProject?
  createdAt      DateTime     @default(now())
}

// Recurring Sessions - templates for automatic session creation
model RecurringSession {
  id              String       @id @default(cuid())
  title           String
  frequency       RecurringFrequency
  dayOfWeek       Int?         // 0-6 for weekly
  dayOfMonth      Int?         // 1-31 for monthly
  time            String?
  evaluationInfo  String?
  isAnonymous     Boolean      @default(true)
  creatorId       String
  creator         User         @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  companyId       String?
  groupId         String?
  isActive        Boolean      @default(true)
  nextRunAt       DateTime?
  lastRunAt       DateTime?
  sessions        VotingSession[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
}

// Hidden Sessions - allows users to hide sessions from their view without deleting
model HiddenSession {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String
  session   VotingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  hiddenAt  DateTime      @default(now())

  @@unique([userId, sessionId])
}

model Participant {
  id            String        @id @default(uuid())
  sessionId     String
  session       VotingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId        String?
  user          User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  displayName   String
  invitedEmail  String?
  inviteToken   String?       @unique
  hasSubmitted  Boolean       @default(false)
  ballots       Ballot[]
}

model Invitation {
  id          String        @id @default(uuid())
  sessionId   String
  session     VotingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  inviterId   String
  inviter     User          @relation(fields: [inviterId], references: [id], onDelete: Cascade)
  inviteeEmail String
  status      InvitationStatus @default(PENDING)
  createdAt   DateTime      @default(now())
}

model Ballot {
  id            String       @id @default(uuid())
  sessionId     String
  session       VotingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participantId String?
  participant   Participant? @relation(fields: [participantId], references: [id], onDelete: SetNull)
  tokenHash     String       @unique
  status        BallotStatus @default(DRAFT)
  votes         Vote[]
  submittedAt   DateTime?
  updatedAt     DateTime     @updatedAt
  createdAt     DateTime     @default(now())
}

model Vote {
  id         String   @id @default(uuid())
  ballotId   String
  ballot     Ballot   @relation(fields: [ballotId], references: [id], onDelete: Cascade)
  personId   String
  percent    Float
}

enum Status {
  OPEN
  CLOSED
}

enum BallotStatus {
  DRAFT
  SUBMITTED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

// Company Groups - smaller groups within a company
model CompanyGroup {
  id          String   @id @default(cuid())
  name        String
  description String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  members     CompanyGroupMember[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, name])
}

model CompanyGroupMember {
  id        String       @id @default(cuid())
  groupId   String
  group     CompanyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedAt   DateTime     @default(now())

  @@unique([groupId, userId])
}

// Classroom for teachers - group work management
model Classroom {
  id            String   @id @default(cuid())
  name          String
  description   String?
  joinCode      String   @unique  // 6-character code for students to join
  teacherId     String
  teacher       User     @relation("TeacherClassrooms", fields: [teacherId], references: [id], onDelete: Cascade)
  students      ClassroomStudent[]
  projects      ClassroomProject[]
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ClassroomStudent {
  id          String    @id @default(cuid())
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?     @relation("StudentClassrooms", fields: [userId], references: [id], onDelete: SetNull)
  studentName String    // Display name for the student
  studentEmail String?
  joinedAt    DateTime  @default(now())

  @@unique([classroomId, studentEmail])
}

model ClassroomProject {
  id            String    @id @default(cuid())
  classroomId   String
  classroom     Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  dueDate       DateTime?
  sessionId     String?   @unique
  session       VotingSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  teacherPoints Int?      // 0-15 points given by teacher for the whole project
  resultsSentAt DateTime? // When results were sent to teacher
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
